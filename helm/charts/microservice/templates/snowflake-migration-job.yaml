{{- if .Values.snowflakeMigration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "microservice.fullname" . }}-snowflake-migrator
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "microservice.name" . }}-snowflake-migrator
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: OnFailure
      containers:
        - name: snowflake-migrator
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python", "/app/migrations/snowflake_migrator.py"]
          envFrom:
            {{- if .Values.secret.externalSecret.enabled }}
            - secretRef:
                name: {{ include "microservice.fullname" . }}-external-secret
            {{- end }}
            {{- if .Values.extraEnvFrom }}
            {{- toYaml .Values.extraEnvFrom | nindent 12 }}
            {{- end }}
          env:
            - name: SNOWFLAKE_SCHEMA
              value: "PUBLIC"
            - name: SNOWFLAKE_ROLE
              value: "ACCOUNTADMIN"
            - name: SNOWFLAKE_PRIVATE_KEY_PATH
              value: "/etc/snowflake/snowflake_private_key.p8"
            - name: SNOWFLAKE_DATABASE
              value: {{ .Values.snowflakeMigration.database | default "DENTAL_ERP_DW" | quote }}
            - name: SNOWFLAKE_WAREHOUSE
              value: {{ .Values.snowflakeMigration.warehouse | default "COMPUTE_WH" | quote }}
          volumeMounts:
            - name: migrations
              mountPath: /app/migrations
              readOnly: true
            - name: snowflake-key
              mountPath: /etc/snowflake
              readOnly: true
      volumes:
        - name: migrations
          configMap:
            name: {{ include "microservice.fullname" . }}-snowflake-migrations
        - name: snowflake-key
          secret:
            secretName: snowflake-credentials
            items:
              - key: snowflake_private_key.p8
                path: snowflake_private_key.p8
{{- end }}
